%!TEX root = ../../common/main.tex

\section{Likelihood fit}
\label{sec:measurement_of_sin2beta:likelihood_fit}

This section presents the model developed to describe the data and estimate the
values and uncertainties of the physics observables using an \uEML fit. Starting
with a short review of the \uEML method, the \acp{PDF} in use to describe the
different dimensions and components is shown, and the fit model is outlined.

The \CP observables of interest \SJpsiKS and \CJpsiKS are estimated in a
multi-dimensional simultaneous \uEML fit. As summarised in
\cref{tab:measurement_of_sin2beta:data_preparation:observables} the seven
observables $\vec{x}$ are given by the reconstructed mass and decay time of the
\Bd candidate, its decay time estimate, and its \OS and \SSpi tag decision as
well as the corresponding mistag estimates
%
\begin{equation}\label{eq:measurement_of_sin2beta:likelihood_fit:observables}
  \vec{x} = (\obsAllList)\eqpd  
\end{equation}
%
The extended likelihood for a total of $N$ observed events in $j$ subsamples of
data, where $n=\sum_j n_j$, is then defined as
%
\begin{equation}\label{eq:measurement_of_sin2beta:likelihood_fit:uEML}
  \Likelihood{}{}\left(\vec{\theta},\vec{n};\vec{x}\right) = \frac{\exponential{-N} N^n}{n!} \prod_j \prod_{i=1}^{n_j} n_j \Prob{j}{}\left(\vec{x}_i;\vec{\theta}\right)\eqcm
\end{equation}
%
where $\vec{n}$ is the numbers of events, and $\vec{\theta}$ the parameters with
unknown values to be estimated by the \uEML fit. \important{Check definition of uEML}

The software library \RooFit---part of the \ROOT software framework---and its
implementation of the \Minuit algorithm is used to minimize the negative
log-likelihood expression $-\ln\Likelihood{}{}$.

In \cref{sec:measurement_of_sin2beta:likelihood_fit:pdfs} the \acp{PDF} used to
build the likelihood function are introduced shortly, before
\cref{sec:measurement_of_sin2beta:likelihood_fit:model} presents the complete
fit model employed by the \uEML fit. The results of fitter validation study are
summarised in \cref{sec:measurement_of_sin2beta:likelihood_fit:validation}.

% ------------------------------------------------------------------------------
\subsection{List of used \aclp{PDF}}
\label{sec:measurement_of_sin2beta:likelihood_fit:pdfs}

The following \acp{PDF} are employed to model the distributions of the fit
observables.

%...............................................................................
\subsubsection{Exponential}
\label{sec:measurement_of_sin2beta:likelihood_fit:pdfs:exponential}

The exponential function with the parameter $\alpha$ to describe \eg the
distribution of combinatorial background candidates with masses $m$.
%
\begin{equation}\label{eq:measurement_of_sin2beta:likelihood_fit:pdfs:exponential}
  \ProbArg{\text{Exponential}}{}(m, \alpha) = \exponential{\alpha m}
\end{equation}

%...............................................................................
\subsubsection{Decay}
\label{sec:measurement_of_sin2beta:likelihood_fit:pdfs:decay}

The decay function is derived from the exponential function with $\alpha =
-\sfrac{1}{\tau}$, where $\tau$ describes the lifetime of candidates with decay
times $t$.
%
\begin{equation}\label{eq:measurement_of_sin2beta:likelihood_fit:pdfs:decay}
  \ProbArg{\text{Decay}}{}{t, \tau} = \exponential{- \frac{t}{\tau}}
\end{equation}

%...............................................................................
\subsubsection{Gaussian}
\label{sec:measurement_of_sin2beta:likelihood_fit:pdfs:gaussian}

A simple Gaussian function described by the central value or mean $\mu$ and the
width $\sigma$ of the distribution.
%
\begin{equation}\label{eq:measurement_of_sin2beta:likelihood_fit:pdfs:gaussian}
  \ProbArg{\text{Gaussian}}{}{x, \mu, \sigma} = \frac{1}{\sigma\sqrt{2\pi}}\exponential{-\frac{1}{2} \left(\frac{x-\mu}{\sigma}\right)^2}
\end{equation}

%...............................................................................
\subsubsection{Lognormal}
\label{sec:measurement_of_sin2beta:likelihood_fit:pdfs:lognormal}

The lognormal function is \eg used to describe the distribution of the decay
time error estimate $\obsTimeError$ and is parametrised by its median $\mu$ and
the parameter $k = \exponential{\sigma}$, where $\sigma$ is named the shape
parameter.
%
\begin{equation}\label{eq:measurement_of_sin2beta:likelihood_fit:pdfs:lognormal}
  \ProbArg{\text{Lognormal}}{}{\obsTimeError, \mu, k} = \frac{1}{\obsTimeError \sqrt{2\pi} \log (k)} \exponential{-\frac{\log^2 \left(\sfrac{\obsTimeError}{\mu}\right)}{2 \log^2(k)}}
\end{equation}

%...............................................................................
\subsubsection{BDecay}
\label{sec:measurement_of_sin2beta:likelihood_fit:pdfs:bdecay}

Generalised exponential function to describe the time evolution of \Bmeson
states with decay times $t$. The coefficients $A$, $B$, $C$, and $D$ can be
adapted to describe \Bmeson mixing, \CP violation, and different asymmetries \eg
in the production of the \Bmesons. The \PDF is further parametrised by the
lifetime parameter $\tau$, the decay width difference $\DG$ and the mass
difference $\dm$ of the \Bmeson mass eigenstates.
%
\begin{multline}\label{eq:measurement_of_sin2beta:likelihood_fit:pdfs:bdecay}
  \ProbArg{\text{BDecay}}{}{t;...} = \\ \exponential{- \frac{t}{\tau}}\left( A \cosh (\DG t) + B \sinh (\DG t) + C \cos (\dm t) + D \sin (\dm t) \right)
\end{multline}

%...............................................................................
\subsubsection{Ipatia}
\label{sec:measurement_of_sin2beta:likelihood_fit:pdfs:ipatia}

The Ipatia \PDF \cite{Santos:2013gra} is a generalisation of the Crystal ball
\PDF \cite{Oreglia:1980cs,Gaiser:1982yw,Skwarnicki:1986xj}, marginalised over
the a priori unknown per-event mass resolution. The \PDF is used to describe the
distribution of the reconstructed $\B$ candidates mass $\obsMass$ and is
parametrised as
%
\begin{multline}\label{eq:measurement_of_sin2beta:likelihood_fit:pdfs:ipatia}
  \ProbArg{\text{Ipatia}}{}{m, \mu, \sigma, \lambda, \zeta, \beta, a_1, a_2, n_1, n_2} = \\
    \begin{cases}
      G(m, \mu, \sigma, \lambda, \zeta, \beta)    & \text{if $-a_1 < \frac{m-\mu}{\sigma} < a_2$} \\
      \frac{G(\mu - a_1 \sigma, \mu, \sigma, \lambda, \zeta, \beta)}{
        \left( 1 - \sfrac{m}{\left( n_1 \frac{G(\mu - a_1 \sigma, \mu, \sigma, \lambda, \zeta, \beta)}{G^\prime(\mu - a_1 \sigma, \mu, \sigma, \lambda, \zeta, \beta)} - a_1 \sigma \right)} \right)^{n_1}
      }     & \text{if $-a_1 > \frac{m-\mu}{\sigma}$} \\
      \frac{G(\mu - a_2 \sigma, \mu, \sigma, \lambda, \zeta, \beta)}{
        \left( 1 - \sfrac{m}{\left( n_2 \frac{G(\mu - a_2 \sigma, \mu, \sigma, \lambda, \zeta, \beta)}{G^\prime(\mu - a_2 \sigma, \mu, \sigma, \lambda, \zeta, \beta)} - a_2 \sigma \right)} \right)^{n_2}
      }     & \text{if $\phantom{-}a_2 < \frac{m-\mu}{\sigma}$} \\
  \end{cases}\eqcm
\end{multline}
%
where $G(x, \mu, \sigma, \lambda, \zeta, \beta)$ defines the generalised hyperbolic function
\begin{multline}\label{eq:measurement_of_sin2beta:likelihood_fit:pdfs:generalised_hyperbolic}
  G(x, \mu, \sigma, \lambda, \zeta, \beta) = \\
  \left(\left(x - \mu\right)^2 + A_\lambda^2(\zeta) \sigma^2 \right)^{\frac{1}{2} \lambda - \frac{1}{4}}
  \exponential{\beta (x - \mu)} K_{\lambda-\frac{1}{2}}
  \left(\zeta \sqrt{1 + \left(\sfrac{x - \mu}{A_\lambda(\zeta) \sigma}\right)^2} \right)\eqcm
\end{multline}
%
with the cylindrical harmonics $K_\lambda$ and
%
\begin{equation}
  A_\lambda^2(\zeta) = \frac{\zeta K_\lambda(\zeta)}{K_{\lambda+1}(\zeta)}\eqpd
\end{equation}
%
Here, $\mu$ and $\sigma$ are comparable to the mean and width known from a
Gaussian distribution. The parameters $\lambda$ and $\zeta$ describe the shape
of the central peak, $\beta$ characterises the asymmetry of the distribution.
The left and right side tails of the distribution are parametrised by $a_i$ and
$n_i$.

% ------------------------------------------------------------------------------
\subsection{Parametrisation of the fit model}
\label{sec:measurement_of_sin2beta:likelihood_fit:model}

The total \PDF is composed of two components for signal and background labelled
\enquote{\Sig} and \enquote{\Bkg}
%
\begin{equation}
  \Norm{\text{Total}}{}\Prob{\text{Total}}{} = \Norm{\Sig}{}\Prob{\Sig}{} + \Norm{\Bkg}{}\Prob{\Bkg}{}\eqcm
\end{equation}
%
where $\Norm{}{}$ are normalisation factors. As the mass and decay time are
uncorrelated the summed \PDF can decomposed into a product of a mass and a decay
time \PDF. The decay time \PDF describes the conditional distributions of the
decay time and its dependent observable dimensions, the decay time resolution
estimate \obsTimeError, the flavour tags \obsTagOSSS, and their associated
mistag probability estimates \obsEtaOSSS.
%
\begin{multline}
  \ProbArg{\Sig/\Bkg}{}{\obsAllList} = \\ 
  \ProbArg{\Sig/\Bkg}{}{\obsMass} \cdot \ProbArg{\Sig/\Bkg}{}{\obsTime, \obsTimeError, \obsTagOS, \obsTagSS, \obsEtaOS, \obsEtaSS}
\end{multline}
%
As shown in \cref{missing}\addref{time mistag correlations} the per-event mistag
estimates are uncorrelated to the reconstructed decay time. Hence, the signal
decay time \PDF can be further decomposed into a product of the conditional
decay time \PDF $\ProbArg{\Sig}{}{\obsTime, \obsTagOS, \obsTagSS \vert
\obsTimeError, \obsEtaOS, \obsEtaSS}$ describing the \Bmeson time evolution as
well as the \CP violating effects, the \PDF \ProbArg{\Sig}{}{\obsTimeError}
describing the resolution estimate, and the \acp{PDF}
\ProbArg{\Sig}{}{\obsEtaOSSS} describing the mistag probability estimates.
%
\begin{multline}
  \ProbArg{\Sig}{}{\obsTime, \obsTimeError, \obsTagOS, \obsTagSS, \obsEtaOS, \obsEtaSS} = \\ 
  \ProbArg{\Sig}{}{\obsTime, \obsTagOS, \obsTagSS \vert \obsTimeError, \obsEtaOS, \obsEtaSS} \cdot
  \ProbArg{\Sig}{}{\obsTimeError} \cdot
  \ProbArg{\Sig}{}{\obsEtaOS} \cdot
  \ProbArg{\Sig}{}{\obsEtaSS}
\end{multline}
%
As the background decay time \PDF does not depend on the mistag probability
distributions, only the decay time error estimate enters the conditional decay
time \PDF.
%
\begin{multline}
  \ProbArg{\Bkg}{}{\obsTime, \obsTimeError, \obsTagOS, \obsTagSS, \obsEtaOS, \obsEtaSS} = \\ 
  \ProbArg{\Bkg}{}{\obsTime, \obsTagOS, \obsTagSS \vert \obsTimeError} \cdot
  \ProbArg{\Bkg}{}{\obsTimeError} \cdot
  \ProbArg{\Bkg}{}{\obsEtaOS} \cdot
  \ProbArg{\Bkg}{}{\obsEtaSS}
\end{multline}
%
With this general structure being outlined, each single dimension and the
parametrisation of the signal and background components are explained. The
utilised \acp{PDF} are listed and it is explained which parameters are shared in
the categories of the simultaneous fit to the different data subsamples (\cf
\cref{sec:measurement_of_sin2beta:data_preparation:subsamples}).

%...............................................................................
\subsubsection{Mass}
\label{sec:measurement_of_sin2beta:likelihood_fit:model:mass}

The \textbf{signal} mass distribution is modelled using an Ipatia \PDF.
Individual parameters are chosen for the track types \catDD and \catLL. The
parameter $\zeta$ is always fixed to zero. The values of the tail parameters
$a_1, a_2, n_1, n_2$ and of the parameter $\lambda$ are determined on simulated
data and fixed to these values in the fit.

The \textbf{background} component is described by a single exponential \PDF. The
parameter $\alpha$ is shared among all subsamples except for \catDD and \catLL.

%...............................................................................
\subsubsection{Decay time}
\label{sec:measurement_of_sin2beta:likelihood_fit:model:decay_time}

%...............................................................................
\subsubsection{Decay time error estimate}
\label{sec:measurement_of_sin2beta:likelihood_fit:model:decay_time_error}

For most subsamples the \textbf{signal} component's distribution is parametrised
using two lognormal \acp{PDF}. The lognormal \acp{PDF} in the (\catLL and
\catOS) subsample share a common median parameter. For candidates lying in the
(\catLL and (\catSS or \catBS)) subsamples a single lognormal \PDF is sufficient
to describe the decay time error estimate distribution. Individual parameters
are chosen depending on the track type and tagging categories, and in case of
the (\catDD and \catOS) category, also on the trigger category.

The \textbf{background} \PDF is composed of two lognormal distributions. In the
\catLL subsample individual parameters are chosen depending on the track type
and tagging categories. Candidates lying in the (\catDD and \catOS and \catAU)
subsample only share parameters in the \catOO and \catOT categories. In all
other subsamples the parameters are shared except for the track type category.

The parameter values are determined in a multi-dimensional fit to the mass,
decay time, and decay time error estimate distributions and subsequently fixed
in the nominal fit to reduce fit times.

%...............................................................................
\subsubsection{Mistag estimate}
\label{sec:measurement_of_sin2beta:likelihood_fit:model:mistag}

The complicated shapes of the mistag estimate distributions have to be modelled
empirically. Popular approaches to model non-parametric distributions are \eg
Gaussian kernel estimations and splines. The later one is used here. Splines are
piece-wise defined polynomials parametrised by interval boundaries
(\emph{knots}), values at these knots, and boundary conditions to ensure a
continues and smooth function. To model the mistag estimate distributions cubic
splines are used as base splines.

For $n$ knots, there are $n+2$ base splines, and accordingly $n+2$ fit
parameters modelling the shape of the resulting \PDF. The knot positions are
chosen arbitrarily at points of noticeable changes in the shape of the described
distributions.

The used knots for the \obsEtaOS and \obsEtaSS distributions are
%
\begin{equation*}
\begin{split}
  \text{\acs{OS} knots} &= \{0.06, 0.10, 0.14, 0.165, 0.23, 0.3, 0.34, 0.36, 0.42, 0.44, 0.48\} , \\
  \text{\acs{SSpi} knots} &= \{0.16, 0.26, 0.36, 0.41, 0.46, 0.482279\} .
\end{split}
\end{equation*}
%
The explanation for the exceptional value of the last \SSpi knot can be found in
the pre-calibration applied. Originally, the \SSpi mistag estimates are cut at
values above $\num{0.44}$. The pre-calibration then shifts this boundary towards
the given value (\cref{sec:flavour_tagging:calibration:ss}). Likewise,
\OS candidates with a mistag estimate larger then $\num{0.48}$ are considered as
\OS untagged. This choice was made to speed up the fit time and to ensure fit
stability. As the candidates removed by this cut hold large mistags, the
reduction of the effective tagging efficiency is found to be insignificant.

The spline parameters are determined in a multi-dimensional fit including mass,
decay time, and mistag estimate. Both, the \OS and the \SSpi mistag
distributions are fitted using cubic splines with different spline parameters
for \catDD and \catLL and otherwise sharing them through all categories. Only in
the signal \OS distributions the differences depending on the track type are
negligible so the parameters are shared in the \catDD and \catLL categories.


\newpage




% ------------------------------------------------------------------------------
\subsection{Fitter validation}
\label{sec:measurement_of_sin2beta:likelihood_fit:validation}
